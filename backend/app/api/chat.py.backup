from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from typing import List, Optional
import logging

from ..core.database import get_db
from ..models.mission import ChatMessage

router = APIRouter()
logger = logging.getLogger(__name__)

@router.post("/message")
async def send_chat_message(
    message_data: dict,
    db: Session = Depends(get_db)
):
    """Send a chat message and get AI response."""
    try:
        # Extract message data
        message = message_data.get("message", "")
        conversation_id = message_data.get("conversation_id", "default")

        # For now, return a basic response - this will be enhanced with AI integration
        response = {
            "response": f"I understand: '{message}'. This is a placeholder response. AI integration will be implemented next.",
            "confidence": 0.8,
            "conversation_id": conversation_id,
            "message_type": "response"
        }

        # Store the chat message
        chat_message = ChatMessage(
            mission_id=message_data.get("mission_id"),
            sender="user",
            content=message,
            message_type="text"
        )
        db.add(chat_message)

        # Store AI response
        ai_message = ChatMessage(
            mission_id=message_data.get("mission_id"),
            sender="ai",
            content=response["response"],
            message_type="response",
            ai_confidence=response["confidence"]
        )
        db.add(ai_message)
        db.commit()

        return {
            "success": True,
            "response": response,
            "message": "Chat message processed successfully"
        }

    except Exception as e:
        logger.error(f"Failed to process chat message: {e}")
        raise HTTPException(status_code=500, detail=f"Failed to process chat message: {str(e)}")

@router.get("/sessions/{conversation_id}")
async def get_chat_session(conversation_id: str, db: Session = Depends(get_db)):
    """Get chat history for a conversation."""
    try:
        messages = db.query(ChatMessage).filter(
            ChatMessage.mission_id == conversation_id
        ).order_by(ChatMessage.created_at).all()

        return {
            "success": True,
            "conversation_id": conversation_id,
            "messages": [
                {
                    "sender": msg.sender,
                    "content": msg.content,
                    "timestamp": msg.created_at.isoformat(),
                    "confidence": msg.ai_confidence
                }
                for msg in messages
            ]
        }

    except Exception as e:
        logger.error(f"Failed to get chat session: {e}")
        raise HTTPException(status_code=500, detail=f"Failed to get chat session: {str(e)}")